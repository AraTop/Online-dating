{% extends 'users/base.html' %}
{% block content %}
<style>.card-img-wrapper {
    position: relative;
    width: 100%;
    height: 300px; /* Длина фотографии */
}

.card-img-top {
    width: 100%;
    height: 140%;
    
}

.card-img-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 10px;
    background: rgba(0, 0, 0, 0); /* Полупрозрачный фон для читаемости */
    color: white; /* Цвет текста по умолчанию */
}

.card-info {
    margin-bottom: 10px;
}

.card-body {
    padding: 10px;
    height: 105px;
    margin-top: 110px;
}

.btn {
    margin-right: 10px;
    margin-top: 5px;
}

/* Применяем фильтр для инвертирования цветов, если изображение светлое */
.card-img-wrapper.light .card-img-overlay {
    background: rgba(255, 255, 255, 0); /* Полупрозрачный фон с меньшей непрозрачностью */
    color: black; /* Цвет текста для светлого фона */
}</style>
    <div class="container">
        <div class="row">
            {% for user in users %}
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-img-wrapper">
                        <img class="card-img-top" src="{{ user.profile_icon.url }}" alt="User profile picture">
                        <div class="card-img-overlay">
                            <div class="card-info">
                                <p class="card-text">{{ user.first_name }}</p>
                                <p class="card-text">{{ user.userprofile.age }} лет</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <a href="/users/{{user.id}}/" class="btn btn-info">Открыть профиль</a>
                        <a href="{% url 'main:like_dislike_user' user.id 'like' %}" class="btn btn-success">Нравится</a>
                        <a href="{% url 'main:like_dislike_user' user.id 'dislike' %}" class="btn btn-danger">Не нравится</a>
                        <a href="{% url 'main:like_dislike_user' user.id 'hide' %}" class="btn btn-warning">Скрыть</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const images = document.querySelectorAll('.card-img-top');
            
            images.forEach(img => {
                img.addEventListener('load', function() {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    context.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight);
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    let r = 0, g = 0, b = 0;
                    const pixelCount = data.length / 4;
                    
                    for (let i = 0; i < pixelCount; i++) {
                        r += data[i * 4];
                        g += data[i * 4 + 1];
                        b += data[i * 4 + 2];
                    }
                    
                    r = r / pixelCount;
                    g = g / pixelCount;
                    b = b / pixelCount;
                    
                    const brightness = (r * 0.299 + g * 0.587 + b * 0.114);
                    
                    if (brightness > 127) {
                        img.closest('.card-img-wrapper').classList.add('light');
                    }
                });
                img.src = img.src; // Trigger image load event
            });
        });
    </script>
{% endblock %}